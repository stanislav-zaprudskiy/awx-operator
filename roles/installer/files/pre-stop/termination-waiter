#/usr/bin/env bash

PRE_STOP_LOG_ROLE="${PRE_STOP_LOG_ROLE:-waiter}"
source $(dirname "$0")/termination-env

{

log "hook has started\n"

log "marker file to check: \"%s\"\n" \
  "$marker_file"

log "sleep between re-checks: \"%ss\"\n" \
  "$recheck_sleep"

log "report progress every: \"%ss\"\n" \
  "$report_every"

n=0
# TODO: check if master is still running, and fail otherwise - as master could
# fail prematurely and then there is no sense to wait for the marker file
# (subsequently, master needs to be updated to report its running status)
while ! [[ -f $marker_file ]]; do
  if [[ $(($n % $report_every)) -eq 0 ]]; then
    log "waiting for marker file to be accessible\n"
  fi
  n=$(($n + 1))
  sleep $recheck_sleep
done

log "marker file found, exiting to proceed to termination\n"

} > "$stdout" 2> "$stderr"
